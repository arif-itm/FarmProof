<!DOCTYPE html>
<html lang="en" id="root">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FarmProof ‚Äî Insurer / Government Portal</title>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #030712
        }

        html.light body {
            background: #f0f9ff !important
        }

        html.light nav {
            background: rgba(255, 255, 255, 0.92) !important;
            border-color: #e2e8f0 !important
        }

        html.light .bg-gray-900 {
            background: #ffffff !important
        }

        html.light .bg-gray-800 {
            background: #f1f5f9 !important
        }

        html.light .bg-gray-800\/60 {
            background: #f8fafc !important
        }

        html.light .bg-gray-950\/90 {
            background: rgba(255, 255, 255, 0.95) !important
        }

        html.light .text-white {
            color: #0f172a !important
        }

        html.light .text-gray-300 {
            color: #334155 !important
        }

        html.light .text-gray-400 {
            color: #475569 !important
        }

        html.light .text-gray-500 {
            color: #64748b !important
        }

        html.light .border-gray-800 {
            border-color: #e2e8f0 !important
        }

        html.light .border-gray-700 {
            border-color: #cbd5e1 !important
        }

        html.light .bg-gray-700 {
            background: #e2e8f0 !important
        }

        html.light input {
            background: #f8fafc !important;
            color: #0f172a !important;
            border-color: #cbd5e1 !important
        }

        html.light .tab-btn.active {
            background: #ffffff !important;
            color: #0f172a !important
        }

        html.light .tab-btn {
            color: #64748b !important
        }

        body,
        nav,
        .bg-gray-900,
        .bg-gray-800,
        .text-white,
        .text-gray-400,
        .border-gray-800 {
            transition: background .25s, color .25s, border-color .25s
        }
    </style>
</head>

<body class="min-h-screen text-white">

    <nav class="fixed top-0 inset-x-0 z-50 flex items-center gap-2 px-4 md:px-5 border-b border-gray-800 bg-gray-950/90 backdrop-blur-xl"
        style="height:60px">
        <a href="index.html" data-portal
            class="flex items-center gap-1.5 text-gray-400 hover:text-white transition-colors text-sm font-medium">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>Back
        </a>
        <div class="w-px h-5 bg-gray-700"></div>
        <div class="flex items-center gap-2 font-black text-base">Farm<span class="text-emerald-400">Proof</span></div>
        <div class="flex-1"></div>
        <button id="theme-btn" onclick="toggleTheme()"
            class="w-8 h-8 flex items-center justify-center rounded-lg border border-gray-700 bg-gray-800 hover:bg-gray-700 text-sm transition-all"
            title="Toggle light/dark">
            <span id="theme-icon">üåô</span>
        </button>
        <div id="live-badge"
            class="flex items-center gap-2 text-xs font-semibold text-gray-400 bg-gray-800 border border-gray-700 px-3 py-1.5 rounded-full">
            <span class="w-2 h-2 rounded-full bg-gray-500"></span>Connecting‚Ä¶
        </div>
    </nav>

    <main class="pt-20 pb-16 px-4 md:px-6 max-w-6xl mx-auto">
        <div class="mb-6">
            <h1 class="text-2xl md:text-3xl font-black mb-1">Analytics &amp; Audit Trail</h1>
            <p class="text-gray-400 text-sm">Full transparency of the insurance pool ‚Äî all events persisted in
                demoDatabase.json, publicly verifiable on Polygon.</p>
        </div>

        <div class="flex gap-1 bg-gray-900 border border-gray-800 rounded-xl p-1 mb-6 overflow-x-auto">
            <button class="tab-btn active flex-1 min-w-max py-2 px-4 rounded-lg text-sm font-semibold transition-all"
                onclick="switchTab('analytics')">üìà Analytics</button>
            <button
                class="tab-btn flex-1 min-w-max py-2 px-4 rounded-lg text-sm font-semibold transition-all text-gray-400"
                onclick="switchTab('audit')">üîó Audit Trail</button>
            <button
                class="tab-btn flex-1 min-w-max py-2 px-4 rounded-lg text-sm font-semibold transition-all text-gray-400"
                onclick="switchTab('registry')">üë®‚Äçüåæ Farmers</button>
            <button
                class="tab-btn flex-1 min-w-max py-2 px-4 rounded-lg text-sm font-semibold transition-all text-gray-400"
                onclick="switchTab('regions')">üìç Regions</button>
        </div>

        <!-- ANALYTICS -->
        <div id="tab-analytics" class="slide-up">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-4 text-center">
                    <div class="text-2xl mb-1">üë®‚Äçüåæ</div>
                    <div id="kpi-f" class="text-2xl font-black text-emerald-400">0</div>
                    <div class="text-xs text-gray-400 mt-0.5 uppercase tracking-wider">Farmers</div>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-4 text-center">
                    <div class="text-2xl mb-1">üí∞</div>
                    <div id="kpi-pool" class="text-2xl font-black text-emerald-400">‡ß≥0</div>
                    <div class="text-xs text-gray-400 mt-0.5 uppercase tracking-wider">Pool Balance</div>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-4 text-center">
                    <div class="text-2xl mb-1">‚ö°</div>
                    <div id="kpi-pouts" class="text-2xl font-black text-blue-400">0</div>
                    <div class="text-xs text-gray-400 mt-0.5 uppercase tracking-wider">Payouts</div>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-4 text-center">
                    <div class="text-2xl mb-1">üõ°Ô∏è</div>
                    <div id="kpi-cov" class="text-2xl font-black text-purple-400">‡ß≥0</div>
                    <div class="text-xs text-gray-400 mt-0.5 uppercase tracking-wider">Coverage</div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-5">
                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-5">
                    <h3 class="font-bold mb-4">Pool Flow (‡ß≥)</h3>
                    <div style="position:relative;height:200px"><canvas id="chart-pool"></canvas></div>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-5">
                    <h3 class="font-bold mb-4">Crop Distribution</h3>
                    <div style="position:relative;height:200px"><canvas id="chart-crop"></canvas></div>
                </div>
            </div>
            <div class="bg-gray-900 border border-gray-800 rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold">Pool Transparency</h3><span
                        class="text-xs font-bold text-purple-400 bg-purple-400/10 border border-purple-400/20 px-2.5 py-1 rounded-full">On-Chain
                        ¬∑ Public ¬∑ demoDatabase.json</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-gray-800 rounded-xl p-4 text-center">
                        <div class="text-2xl mb-1">üì•</div>
                        <div id="tp-in" class="text-xl font-black text-emerald-400">‡ß≥0</div>
                        <div class="text-xs text-gray-400 mt-0.5">Total Premiums In</div>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-4 text-center">
                        <div class="text-2xl mb-1">üì§</div>
                        <div id="tp-out" class="text-xl font-black text-red-400">‡ß≥0</div>
                        <div class="text-xs text-gray-400 mt-0.5">Total Paid Out</div>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-4 text-center">
                        <div class="text-2xl mb-1">üè¶</div>
                        <div id="tp-res" class="text-xl font-black text-blue-400">‡ß≥0</div>
                        <div class="text-xs text-gray-400 mt-0.5">Pool Reserve</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AUDIT -->
        <div id="tab-audit" class="hidden">
            <div class="bg-gray-900 border border-gray-800 rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-lg">Immutable Ledger</h3><span id="led-count"
                        class="text-xs font-semibold text-gray-400 bg-gray-800 border border-gray-700 px-2.5 py-1 rounded-full">0
                        records</span>
                </div>
                <div
                    class="flex items-center gap-2 bg-gray-800 border border-gray-700 focus-within:border-purple-500 rounded-xl px-3.5 py-2.5 mb-3 transition-all">
                    <svg class="w-4 h-4 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-4.35-4.35" />
                    </svg>
                    <input id="audit-q" type="text" placeholder="Search by actor, type, or TxHash‚Ä¶"
                        class="bg-transparent text-sm text-white outline-none w-full placeholder-gray-500" />
                </div>
                <div class="flex gap-2 flex-wrap mb-4">
                    <button
                        class="filter-btn active text-xs font-semibold text-emerald-400 bg-emerald-400/10 border border-emerald-400/20 px-3 py-1 rounded-full"
                        data-f="all">All</button>
                    <button
                        class="filter-btn text-xs font-semibold text-gray-400 bg-gray-800 border border-gray-700 px-3 py-1 rounded-full"
                        data-f="registration">Registration</button>
                    <button
                        class="filter-btn text-xs font-semibold text-gray-400 bg-gray-800 border border-gray-700 px-3 py-1 rounded-full"
                        data-f="premium">Premium</button>
                    <button
                        class="filter-btn text-xs font-semibold text-gray-400 bg-gray-800 border border-gray-700 px-3 py-1 rounded-full"
                        data-f="oracle">Oracle</button>
                    <button
                        class="filter-btn text-xs font-semibold text-gray-400 bg-gray-800 border border-gray-700 px-3 py-1 rounded-full"
                        data-f="payout">Payout</button>
                </div>
                <div class="overflow-x-auto rounded-xl border border-gray-800">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-800">
                                <th
                                    class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase tracking-wider font-semibold">
                                    Block</th>
                                <th
                                    class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase tracking-wider font-semibold">
                                    Time</th>
                                <th
                                    class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase tracking-wider font-semibold">
                                    Event</th>
                                <th
                                    class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase tracking-wider font-semibold">
                                    Actor</th>
                                <th
                                    class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase tracking-wider font-semibold hidden md:table-cell">
                                    Details</th>
                                <th
                                    class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase tracking-wider font-semibold">
                                    TxHash</th>
                            </tr>
                        </thead>
                        <tbody id="audit-body" class="divide-y divide-gray-800"></tbody>
                    </table>
                </div>
                <div class="flex gap-2 items-center flex-wrap bg-gray-800 rounded-xl p-3 mt-4">
                    <svg class="w-4 h-4 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                    </svg>
                    <input id="verify-in" type="text" placeholder="Paste TxHash to verify on-chain‚Ä¶"
                        class="flex-1 bg-transparent text-sm text-white outline-none placeholder-gray-500 min-w-0" />
                    <button id="verify-btn"
                        class="bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold px-3 py-1.5 rounded-lg text-xs transition-colors">Verify</button>
                    <span id="verify-out" class="text-xs font-semibold"></span>
                </div>
            </div>
        </div>

        <!-- REGISTRY -->
        <div id="tab-registry" class="hidden">
            <div class="bg-gray-900 border border-gray-800 rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-lg">Farmer Registry (On-Chain)</h3><span id="reg-count"
                        class="text-xs font-semibold text-gray-400 bg-gray-800 border border-gray-700 px-2.5 py-1 rounded-full">0
                        farmers</span>
                </div>
                <div class="overflow-x-auto rounded-xl border border-gray-800">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-800">
                                <th class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase">Farmer</th>
                                <th class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase">Crop</th>
                                <th class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase hidden sm:table-cell">
                                    Land</th>
                                <th class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase">Coverage</th>
                                <th class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase">Status</th>
                                <th class="text-left px-3 py-2.5 text-xs text-gray-500 uppercase hidden md:table-cell">
                                    Date</th>
                            </tr>
                        </thead>
                        <tbody id="reg-body" class="divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- REGIONS -->
        <div id="tab-regions" class="hidden">
            <div class="bg-gray-900 border border-gray-800 rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-lg">Regional Map ‚Äî Sylhet Division</h3><span id="reg-events"
                        class="text-xs font-semibold text-emerald-400 bg-emerald-400/10 border border-emerald-400/20 px-2.5 py-1 rounded-full">0
                        events</span>
                </div>
                <div class="space-y-3 mb-4">
                    <div
                        class="flex items-center gap-3 bg-gray-800 border border-gray-700 hover:border-emerald-500/40 rounded-xl p-3.5 transition-all">
                        <span class="w-3 h-3 rounded-full bg-emerald-400 flex-shrink-0"
                            style="box-shadow:0 0 8px rgba(52,211,153,.5)"></span>
                        <div class="flex-1">
                            <div class="font-semibold text-sm">Sunamganj District</div>
                            <div class="text-xs text-gray-400">Haor wetland ¬∑ Primary monitoring zone</div>
                        </div>
                        <div class="text-right">
                            <div id="r-payouts" class="text-sm font-bold text-emerald-400">0 payouts</div>
                            <div id="r-total" class="text-xs text-gray-400">‡ß≥0 paid</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 bg-gray-800 border border-gray-800 rounded-xl p-3.5"><span
                            class="w-3 h-3 rounded-full bg-gray-600 flex-shrink-0"></span>
                        <div class="flex-1">
                            <div class="font-semibold text-sm">Sylhet Sadar</div>
                            <div class="text-xs text-gray-400">River Surma basin</div>
                        </div>
                        <div class="text-sm text-gray-500">No Events</div>
                    </div>
                    <div class="flex items-center gap-3 bg-gray-800 border border-gray-800 rounded-xl p-3.5"><span
                            class="w-3 h-3 rounded-full bg-gray-600 flex-shrink-0"></span>
                        <div class="flex-1">
                            <div class="font-semibold text-sm">Netrokona</div>
                            <div class="text-xs text-gray-400">River Kangsha basin</div>
                        </div>
                        <div class="text-sm text-gray-500">No Events</div>
                    </div>
                    <div class="flex items-center gap-3 bg-gray-800 border border-gray-800 rounded-xl p-3.5"><span
                            class="w-3 h-3 rounded-full bg-gray-600 flex-shrink-0"></span>
                        <div class="flex-1">
                            <div class="font-semibold text-sm">Kishoreganj</div>
                            <div class="text-xs text-gray-400">River Meghna basin</div>
                        </div>
                        <div class="text-sm text-gray-500">No Events</div>
                    </div>
                </div>
                <div class="bg-blue-500/5 border border-blue-500/20 rounded-xl p-4 text-sm text-blue-200">
                    <strong class="text-white">Compliance note:</strong> All payout records meet Bangladesh Insurance
                    Act (IDRA) audit requirements. Every event is stored in demoDatabase.json and immutably on Polygon.
                    Government agencies (DAE, MoA) and donors can verify any TxHash on PolygonScan.
                </div>
            </div>
        </div>
    </main>

    <div id="fp-toast"></div>
    <script src="shared.js"></script>
    <script>
        let poolChart = null, cropChart = null, auditFilter = 'all', auditQ = '';
        const TAB_IDS = ['analytics', 'audit', 'registry', 'regions'];

        function switchTab(id) {
            document.querySelectorAll('.tab-btn').forEach((b, i) => {
                if (TAB_IDS[i] === id) { b.classList.add('active', 'bg-gray-800', 'text-white'); b.classList.remove('text-gray-400'); }
                else { b.classList.remove('active', 'bg-gray-800', 'text-white'); b.classList.add('text-gray-400'); }
            });
            TAB_IDS.forEach(t => {
                const el = document.getElementById('tab-' + t);
                if (t === id) { el.classList.remove('hidden'); el.classList.add('slide-up'); } else el.classList.add('hidden');
            });
            if (id === 'analytics') renderAnalytics();
            if (id === 'audit') renderAudit();
            if (id === 'registry') renderRegistry();
            if (id === 'regions') renderRegions();
        }

        function evClass(type) {
            const m = { registration: 'text-blue-400 bg-blue-400/10 border-blue-400/20', premium: 'text-amber-400 bg-amber-400/10 border-amber-400/20', oracle: 'text-purple-400 bg-purple-400/10 border-purple-400/20', payout: 'text-emerald-400 bg-emerald-400/10 border-emerald-400/20', admin: 'text-red-400 bg-red-400/10 border-red-400/20' };
            return m[type] || 'text-gray-400 bg-gray-800 border-gray-700';
        }

        function renderAnalytics() {
            const f = AppState.farmers;
            const poolIn = f.reduce((s, x) => s + x.premium, 0), poolOut = AppState.payoutTotal, reserve = Math.max(0, poolIn - poolOut);
            document.getElementById('kpi-f').textContent = f.length;
            document.getElementById('kpi-pool').textContent = '‡ß≥' + AppState.poolBalance.toLocaleString();
            document.getElementById('kpi-pouts').textContent = AppState.payoutCount;
            document.getElementById('kpi-cov').textContent = '‡ß≥' + AppState.totalCoverage.toLocaleString();
            document.getElementById('tp-in').textContent = '‡ß≥' + poolIn.toLocaleString();
            document.getElementById('tp-out').textContent = '‡ß≥' + poolOut.toLocaleString();
            document.getElementById('tp-res').textContent = '‡ß≥' + reserve.toLocaleString();
            if (poolChart) poolChart.destroy();
            poolChart = new Chart(document.getElementById('chart-pool'), { type: 'bar', data: { labels: ['Premiums In', 'Payouts Out', 'Reserve'], datasets: [{ data: [poolIn, poolOut, reserve], backgroundColor: ['rgba(16,185,129,.7)', 'rgba(239,68,68,.7)', 'rgba(59,130,246,.7)'], borderColor: ['#10b981', '#ef4444', '#3b82f6'], borderWidth: 1, borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(255,255,255,.03)' } }, y: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(255,255,255,.03)' } } } } });
            const cropMap = {}; f.forEach(x => { cropMap[x.crop] = (cropMap[x.crop] || 0) + 1; });
            const labels = Object.keys(cropMap).length ? Object.keys(cropMap) : ['No data'], values = Object.values(cropMap).length ? Object.values(cropMap) : [1];
            const clrs = ['#10b981', '#3b82f6', '#a855f7', '#f59e0b', '#ef4444'];
            if (cropChart) cropChart.destroy();
            cropChart = new Chart(document.getElementById('chart-crop'), { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: labels.map((_, i) => clrs[i % clrs.length]), borderColor: '#111827', borderWidth: 3 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '62%', plugins: { legend: { labels: { color: '#9ca3af', font: { size: 11 } } } } } });
        }

        function renderAudit() {
            let entries = AppState.ledger;
            document.getElementById('led-count').textContent = entries.length + ' records';
            if (auditFilter !== 'all') entries = entries.filter(e => e.type === auditFilter);
            if (auditQ) { const q = auditQ.toLowerCase(); entries = entries.filter(e => (e.txHash || '').toLowerCase().includes(q) || (e.type || '').includes(q) || (e.actor || '').toLowerCase().includes(q) || (e.data || '').toLowerCase().includes(q)); }
            const tbody = document.getElementById('audit-body');
            if (!entries.length) { tbody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500 text-sm">${AppState.ledger.length ? 'No events match this filter.' : 'No events yet. Register farmers and simulate a flood.'}</td></tr>`; return; }
            tbody.innerHTML = entries.map(e => `<tr class="hover:bg-gray-800/40 transition-colors"><td class="px-3 py-2.5 font-mono text-xs text-gray-500">#${(e.block || 0).toLocaleString()}</td><td class="px-3 py-2.5 text-xs text-gray-400 whitespace-nowrap">${UI.formatTime(e.timestamp)}</td><td class="px-3 py-2.5"><span class="text-xs font-bold px-2 py-0.5 rounded-full border ${evClass(e.type)}">${e.type.toUpperCase()}</span></td><td class="px-3 py-2.5 text-sm max-w-28 truncate">${e.actor}</td><td class="px-3 py-2.5 text-xs text-gray-400 max-w-48 truncate hidden md:table-cell">${e.data}</td><td class="px-3 py-2.5 font-mono text-xs text-gray-500 cursor-pointer hover:text-purple-400 transition-colors" title="${e.txHash}" onclick="document.getElementById('verify-in').value='${e.txHash}'">${UI.shortHash(e.txHash)}</td></tr>`).join('');
        }

        function renderRegistry() {
            const f = AppState.farmers;
            document.getElementById('reg-count').textContent = f.length + ' farmers';
            document.getElementById('reg-body').innerHTML = f.length ? f.map(x => `<tr class="hover:bg-gray-800/40 transition-colors"><td class="px-3 py-2.5 font-semibold">${x.name}</td><td class="px-3 py-2.5 text-gray-300">${x.crop}</td><td class="px-3 py-2.5 text-gray-300 hidden sm:table-cell">${x.area} bigha</td><td class="px-3 py-2.5 font-semibold">‡ß≥${x.coverage.toLocaleString()}</td><td class="px-3 py-2.5"><span class="text-xs font-bold px-2 py-0.5 rounded-full border ${x.paid ? 'text-blue-400 bg-blue-400/10 border-blue-400/20' : 'text-emerald-400 bg-emerald-400/10 border-emerald-400/20'}">${x.paid ? 'PAID ‚ö°' : 'ACTIVE'}</span></td><td class="px-3 py-2.5 text-xs text-gray-500 hidden md:table-cell">${UI.formatDate(x.registeredAt)}</td></tr>`).join('')
                : '<tr><td colspan="6" class="text-center py-10 text-gray-500 text-sm">No farmers registered yet.</td></tr>';
        }

        function renderRegions() {
            const pouts = AppState.ledger.filter(e => e.type === 'payout'), total = pouts.reduce((s, p) => s + (p.amount || 0), 0);
            document.getElementById('reg-events').textContent = pouts.length + ' events';
            document.getElementById('r-payouts').textContent = pouts.length + ' payout' + (pouts.length === 1 ? '' : 's');
            document.getElementById('r-total').textContent = '‡ß≥' + total.toLocaleString() + ' paid';
        }

        function refreshActiveTab() {
            const active = TAB_IDS.find(t => !document.getElementById('tab-' + t).classList.contains('hidden'));
            if (active === 'analytics') renderAnalytics();
            if (active === 'audit') renderAudit();
            if (active === 'registry') renderRegistry();
            if (active === 'regions') renderRegions();
        }

        /* Filters */
        document.querySelectorAll('.filter-btn').forEach(b => {
            b.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(x => { x.className = 'filter-btn text-xs font-semibold text-gray-400 bg-gray-800 border border-gray-700 hover:border-purple-400 px-3 py-1 rounded-full transition-all'; });
                b.className = 'filter-btn active text-xs font-semibold text-emerald-400 bg-emerald-400/10 border border-emerald-400/20 px-3 py-1 rounded-full transition-all';
                auditFilter = b.dataset.f; renderAudit();
            });
        });
        document.getElementById('audit-q').addEventListener('input', e => { auditQ = e.target.value; renderAudit(); });
        document.getElementById('verify-btn').addEventListener('click', () => {
            const hash = document.getElementById('verify-in').value.trim(), found = AppState.ledger.find(e => e.txHash === hash), out = document.getElementById('verify-out');
            out.style.color = found ? '#10b981' : '#ef4444'; out.textContent = found ? `‚úì Block #${found.block?.toLocaleString()} ¬∑ ${found.type} ¬∑ ${found.actor}` : (hash ? '‚úó Not found in ledger' : '');
        });

        /* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
        (async () => {
            await AppState.init();
            const badge = document.getElementById('live-badge');
            badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-purple-400 dot-pulse"></span>Live ¬∑ Insurer Portal';
            badge.className = 'flex items-center gap-2 text-xs font-semibold text-purple-400 bg-purple-400/10 border border-purple-400/20 px-3 py-1.5 rounded-full';

            StateEvents.on('payout', () => {
                refreshActiveTab();
                UI.showToast('‚ö° Payout event received from Oracle! demoDatabase.json updated.', 'success', 5000);
            });
            StateEvents.on('registration', () => refreshActiveTab());
            StateEvents.on('update', () => refreshActiveTab());
            StateEvents.on('reset', () => { refreshActiveTab(); UI.showToast('üîÑ System reset by Admin', 'info'); });

            renderAnalytics();
        })();
        /* ‚îÄ‚îÄ Theme ‚îÄ‚îÄ */
        let _theme = localStorage.getItem('fp_theme') || 'dark';
        function applyTheme(t) {
            _theme = t;
            document.getElementById('root').classList.toggle('light', t === 'light');
            document.getElementById('root').classList.toggle('dark', t !== 'light');
            document.getElementById('theme-icon').textContent = t === 'light' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('fp_theme', t);
        }
        function toggleTheme() { applyTheme(_theme === 'dark' ? 'light' : 'dark'); }
        applyTheme(_theme);
    </script>
</body>

</html>