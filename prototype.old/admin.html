<!DOCTYPE html>
<html lang="en" id="root">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FarmProof ‚Äî Admin Portal</title>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #030712
        }

        html.light body {
            background: #f0f9ff !important
        }

        html.light nav {
            background: rgba(255, 255, 255, 0.92) !important;
            border-color: #e2e8f0 !important
        }

        html.light .bg-gray-900 {
            background: #ffffff !important
        }

        html.light .bg-gray-800 {
            background: #f1f5f9 !important
        }

        html.light .bg-gray-950\/90 {
            background: rgba(255, 255, 255, 0.95) !important
        }

        html.light .text-white {
            color: #0f172a !important
        }

        html.light .text-gray-300 {
            color: #334155 !important
        }

        html.light .text-gray-400 {
            color: #475569 !important
        }

        html.light .text-gray-500 {
            color: #64748b !important
        }

        html.light .border-gray-800 {
            border-color: #e2e8f0 !important
        }

        html.light .border-gray-700 {
            border-color: #cbd5e1 !important
        }

        html.light .bg-gray-700 {
            background: #e2e8f0 !important
        }

        html.light input[type=range] {
            accent-color: #10b981
        }

        body,
        nav,
        .bg-gray-900,
        .bg-gray-800,
        .text-white,
        .text-gray-400,
        .border-gray-800 {
            transition: background .25s, color .25s, border-color .25s
        }
    </style>
</head>

<body class="min-h-screen text-white">

    <nav class="fixed top-0 inset-x-0 z-50 flex items-center gap-2 px-4 md:px-5 border-b border-gray-800 bg-gray-950/90 backdrop-blur-xl"
        style="height:60px">
        <a href="index.html" data-portal
            class="flex items-center gap-1.5 text-gray-400 hover:text-white transition-colors text-sm font-medium">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>Back
        </a>
        <div class="w-px h-5 bg-gray-700"></div>
        <div class="flex items-center gap-2 font-black text-base">Farm<span class="text-emerald-400">Proof</span></div>
        <div class="flex-1"></div>
        <button id="theme-btn" onclick="toggleTheme()"
            class="w-8 h-8 flex items-center justify-center rounded-lg border border-gray-700 bg-gray-800 hover:bg-gray-700 text-sm transition-all"
            title="Toggle light/dark">
            <span id="theme-icon">üåô</span>
        </button>
        <div id="live-badge"
            class="flex items-center gap-2 text-xs font-semibold text-gray-400 bg-gray-800 border border-gray-700 px-3 py-1.5 rounded-full">
            <span class="w-2 h-2 rounded-full bg-gray-500"></span>Connecting‚Ä¶
        </div>
    </nav>

    <main class="pt-20 pb-16 px-4 md:px-6 max-w-6xl mx-auto">
        <div class="mb-6">
            <h1 class="text-2xl md:text-3xl font-black mb-1">Contract Configuration</h1>
            <p class="text-gray-400 text-sm">Adjust trigger thresholds and coverage settings. All changes persist to
                <code
                    class="font-mono text-amber-400 bg-amber-400/10 px-1.5 py-0.5 rounded text-xs">demoDatabase.json</code>
                and broadcast live to all open portals.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <!-- LEFT: Settings -->
            <div class="space-y-5">
                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-5">
                    <div class="flex items-center justify-between mb-5">
                        <h2 class="font-bold">Trigger Thresholds</h2>
                        <span
                            class="text-xs font-bold text-red-400 bg-red-400/10 border border-red-400/20 px-2.5 py-1 rounded-full">Critical
                            ¬∑ Oracle uses these</span>
                    </div>
                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2"><label class="text-sm font-semibold">üåßÔ∏è
                                72-Hour Rainfall Threshold</label><span id="tv-rain"
                                class="font-mono font-bold text-emerald-400 text-sm">200 mm</span></div>
                        <input type="range" id="sl-rain" min="100" max="400" value="200" step="10" class="w-full" />
                        <div class="flex justify-between text-xs text-gray-500 mt-1.5"><span>100mm (very
                                sensitive)</span><span>400mm (extreme only)</span></div>
                    </div>
                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2"><label class="text-sm font-semibold">üõ∞Ô∏è
                                NDVI Drop Threshold</label><span id="tv-ndvi"
                                class="font-mono font-bold text-emerald-400 text-sm">40 %</span></div>
                        <input type="range" id="sl-ndvi" min="20" max="80" value="40" step="5" class="w-full" />
                        <div class="flex justify-between text-xs text-gray-500 mt-1.5"><span>20%
                                (sensitive)</span><span>80% (severe loss only)</span></div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between items-center mb-2"><label class="text-sm font-semibold">üåä
                                River Level Threshold</label><span id="tv-river"
                                class="font-mono font-bold text-emerald-400 text-sm">8.5 m</span></div>
                        <input type="range" id="sl-river" min="5" max="15" value="8.5" step="0.5" class="w-full" />
                        <div class="flex justify-between text-xs text-gray-500 mt-1.5"><span>5m (very
                                sensitive)</span><span>15m (extreme flood only)</span></div>
                    </div>
                </div>

                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-5">
                    <h2 class="font-bold mb-5">Coverage &amp; Operations</h2>
                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2"><label class="text-sm font-semibold">üí∞
                                Standard Coverage Amount</label><span id="tv-cov"
                                class="font-mono font-bold text-emerald-400 text-sm">‡ß≥50,000</span></div>
                        <input type="range" id="sl-cov" min="10000" max="200000" value="50000" step="5000"
                            class="w-full" />
                        <div class="flex justify-between text-xs text-gray-500 mt-1.5">
                            <span>‡ß≥10,000</span><span>‡ß≥200,000</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between items-center mb-2"><label class="text-sm font-semibold">‚è±Ô∏è
                                Oracle Fetch Interval</label><span id="tv-int"
                                class="font-mono font-bold text-emerald-400 text-sm">6 hours</span></div>
                        <input type="range" id="sl-int" min="1" max="24" value="6" step="1" class="w-full" />
                        <div class="flex justify-between text-xs text-gray-500 mt-1.5"><span>1h (near
                                real-time)</span><span>24h (daily)</span></div>
                    </div>
                </div>

                <button id="save-btn"
                    class="w-full flex items-center justify-center gap-2 bg-amber-500 hover:bg-amber-400 active:bg-amber-600 text-gray-950 font-black py-3 rounded-xl text-sm transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                            d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z" />
                        <polyline points="17 21 17 13 7 13 7 21" />
                        <polyline points="7 3 7 8 15 8" />
                    </svg>
                    Save &amp; Broadcast to All Portals
                </button>
                <div id="save-msg" class="text-xs text-emerald-400 font-semibold text-center"></div>

                <!-- DANGER ZONE -->
                <div class="bg-red-500/5 border border-red-500/20 rounded-2xl p-5">
                    <h3 class="font-bold text-red-400 mb-1">‚ö†Ô∏è Demo Reset</h3>
                    <p class="text-sm text-gray-400 mb-1">Clears ALL session data in <code
                            class="font-mono text-amber-400 text-xs">demoDatabase.json</code> and resets to a fresh
                        empty state.</p>
                    <p class="text-xs text-gray-500 mb-4">All open portals (Farmer, Oracle, Insurer) will live-update
                        instantly via SSE.</p>
                    <button id="reset-btn"
                        class="bg-transparent border border-red-500/30 text-red-400 hover:bg-red-500/10 font-semibold px-4 py-2 rounded-xl text-sm transition-all">
                        üóëÔ∏è Reset All Data ‚Äî Clear demoDatabase.json
                    </button>
                </div>
            </div>

            <!-- RIGHT: Live contract state + tx log -->
            <div class="space-y-5">
                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-bold">Live Contract State</h2>
                        <span
                            class="text-xs font-bold text-amber-400 bg-amber-400/10 border border-amber-400/20 px-2.5 py-1 rounded-full">demoDatabase.json</span>
                    </div>
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Deployment</div>
                    <div class="space-y-2 mb-5 text-sm">
                        <div class="flex justify-between"><span class="text-gray-400">Contract</span><span
                                class="font-mono text-xs text-gray-500">0x7B4a3f‚Ä¶3Fc2</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Network</span><span
                                class="font-semibold text-emerald-400">Polygon Amoy</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Current Block</span><span
                                id="c-block" class="font-mono font-bold">‚Äî</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Oracle Address</span><span
                                class="font-mono text-xs text-gray-500">0xOracle‚Ä¶F1a9</span></div>
                    </div>
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Active Thresholds
                    </div>
                    <div class="space-y-2 mb-5 text-sm">
                        <div class="flex justify-between"><span class="text-gray-400">üåßÔ∏è Rainfall</span><span
                                id="c-rain" class="font-bold">200 mm</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">üõ∞Ô∏è NDVI Drop</span><span
                                id="c-ndvi" class="font-bold">40 %</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">üåä River Level</span><span
                                id="c-river" class="font-bold">8.5 m</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">‚è± Oracle Interval</span><span
                                id="c-int" class="font-bold">6 hours</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Last Updated</span><span
                                id="c-updated" class="font-bold text-gray-400">Never</span></div>
                    </div>
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Pool Statistics</div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-gray-400">Pool Balance</span><span
                                id="c-pool" class="font-bold text-emerald-400">‡ß≥0</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Active Policies</span><span
                                id="c-pols" class="font-bold">0</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Total Coverage</span><span
                                id="c-cov-val" class="font-bold">‡ß≥0</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Payouts Made</span><span
                                id="c-pouts" class="font-bold">0</span></div>
                    </div>
                </div>

                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-bold">Admin Transactions</h2>
                        <span id="atx-count"
                            class="text-xs font-semibold text-gray-400 bg-gray-800 border border-gray-700 px-2.5 py-1 rounded-full">0
                            txs</span>
                    </div>
                    <div id="atx-list">
                        <div class="text-center py-8">
                            <div class="text-3xl mb-2">üìã</div>
                            <div class="text-sm text-gray-500">No transactions yet.<br />Save thresholds to generate
                                one.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="fp-toast"></div>
    <script src="shared.js"></script>
    <script>
        const SLIDERS = [
            { id: 'sl-rain', valId: 'tv-rain', cfgId: 'c-rain', key: 'rainfall', min: 100, max: 400, fmt: v => v + ' mm' },
            { id: 'sl-ndvi', valId: 'tv-ndvi', cfgId: 'c-ndvi', key: 'ndvi', min: 20, max: 80, fmt: v => v + ' %' },
            { id: 'sl-river', valId: 'tv-river', cfgId: 'c-river', key: 'river', min: 5, max: 15, fmt: v => v + ' m' },
            { id: 'sl-cov', valId: 'tv-cov', cfgId: null, key: null, min: 10000, max: 200000, fmt: v => '‡ß≥' + parseInt(v).toLocaleString() },
            { id: 'sl-int', valId: 'tv-int', cfgId: 'c-int', key: null, min: 1, max: 24, fmt: v => v + (parseInt(v) === 1 ? ' hour' : ' hours') },
        ];

        function updateSliderBg(el, s) {
            const v = parseFloat(el.value), pct = ((v - s.min) / (s.max - s.min)) * 100;
            el.style.background = `linear-gradient(90deg,#10b981 ${pct}%,#374151 ${pct}%)`;
            document.getElementById(s.valId).textContent = s.fmt(v);
        }

        function refreshStats() {
            document.getElementById('c-block').textContent = '#' + AppState.blockNumber.toLocaleString();
            document.getElementById('c-rain').textContent = AppState.thresholds.rainfall + ' mm';
            document.getElementById('c-ndvi').textContent = AppState.thresholds.ndvi + ' %';
            document.getElementById('c-river').textContent = AppState.thresholds.river + ' m';
            document.getElementById('c-pool').textContent = '‡ß≥' + AppState.poolBalance.toLocaleString();
            document.getElementById('c-pols').textContent = AppState.farmers.length;
            document.getElementById('c-cov-val').textContent = '‡ß≥' + AppState.totalCoverage.toLocaleString();
            document.getElementById('c-pouts').textContent = AppState.payoutCount;
        }

        let adminTxs = [];
        function renderAdminTxs() {
            document.getElementById('atx-count').textContent = adminTxs.length + ' txs';
            document.getElementById('atx-list').innerHTML = adminTxs.length ? adminTxs.map(tx => `
    <div class="bg-gray-800 border border-gray-700 rounded-xl p-3.5 mb-3 slide-up">
      <div class="flex items-center justify-between mb-3"><span class="text-xs font-bold text-red-400 bg-red-400/10 border border-red-400/20 px-2 py-0.5 rounded-full">THRESHOLD UPDATE</span><span class="font-mono text-xs text-gray-500">Block #${tx.entry.block.toLocaleString()}</span></div>
      <div class="grid grid-cols-3 gap-2 mb-2.5">
        <div class="bg-gray-900 rounded-lg p-2 text-center"><div class="text-xs text-gray-500">Rainfall</div><div class="font-bold text-sm">${tx.rain}mm</div></div>
        <div class="bg-gray-900 rounded-lg p-2 text-center"><div class="text-xs text-gray-500">NDVI</div><div class="font-bold text-sm">${tx.ndvi}%</div></div>
        <div class="bg-gray-900 rounded-lg p-2 text-center"><div class="text-xs text-gray-500">River</div><div class="font-bold text-sm">${tx.river}m</div></div>
      </div>
      <div class="font-mono text-xs text-gray-500 truncate">TxHash: ${UI.shortHash(tx.entry.txHash)}</div>
    </div>`).join('')
                : '<div class="text-center py-8"><div class="text-3xl mb-2">üìã</div><div class="text-sm text-gray-500">No transactions yet.</div></div>';
        }

        document.getElementById('save-btn').addEventListener('click', () => {
            const rain = parseFloat(document.getElementById('sl-rain').value);
            const ndvi = parseFloat(document.getElementById('sl-ndvi').value);
            const river = parseFloat(document.getElementById('sl-river').value);
            const intv = parseInt(document.getElementById('sl-int').value);
            AppState.thresholds = { rainfall: rain, ndvi, river };
            const entry = Blockchain.addEntry('oracle', 'Admin', `Thresholds updated: rain=${rain}mm ndvi=${ndvi}% river=${river}m interval=${intv}h`);
            document.getElementById('c-int').textContent = intv + (intv === 1 ? ' hour' : ' hours');
            document.getElementById('c-updated').textContent = UI.formatTime(new Date());
            document.getElementById('save-msg').textContent = `‚úì Saved at block #${entry.block.toLocaleString()} ¬∑ ` + UI.formatTime(new Date());
            adminTxs.unshift({ rain, ndvi, river, intv, entry });
            // Broadcast to all open tabs
            AppState.save('update', { admin: true, thresholds: AppState.thresholds });
            renderAdminTxs(); refreshStats();
            UI.showToast('‚úÖ Thresholds saved & broadcast to all portals ¬∑ demoDatabase.json updated', 'success');
        });

        document.getElementById('reset-btn').addEventListener('click', async () => {
            if (!confirm('Reset ALL data in demoDatabase.json?\nAll portals will instantly clear. This cannot be undone.')) return;
            // POST to /api/reset ‚Äî wipes demoDatabase.json and broadcasts SSE 'reset' to all tabs
            await AppState.reset();
            adminTxs = [];
            renderAdminTxs(); refreshStats();
            // Reset sliders to defaults
            SLIDERS.forEach(s => {
                const el = document.getElementById(s.id);
                if (s.key && el) el.value = ({ rainfall: 200, ndvi: 40, river: 8.5 }[s.key] || el.value);
                updateSliderBg(el, s);
            });
            document.getElementById('sl-int').value = 6; updateSliderBg(document.getElementById('sl-int'), SLIDERS[4]);
            document.getElementById('save-msg').textContent = '';
            document.getElementById('c-updated').textContent = 'Never';
            UI.showToast('üîÑ All data cleared ¬∑ demoDatabase.json reset ¬∑ All portals notified', 'success', 5000);
        });

        /* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
        (async () => {
            await AppState.init();
            const badge = document.getElementById('live-badge');
            badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-amber-400 dot-pulse"></span>Live ¬∑ Admin Portal';
            badge.className = 'flex items-center gap-2 text-xs font-semibold text-amber-400 bg-amber-400/10 border border-amber-400/20 px-3 py-1.5 rounded-full';

            // Subscribe to SSE for external state changes
            StateEvents.on('payout', () => refreshStats());
            StateEvents.on('registration', () => refreshStats());
            StateEvents.on('update', () => refreshStats());
            StateEvents.on('reset', () => { adminTxs = []; renderAdminTxs(); refreshStats(); });

            // Init sliders with current thresholds from DB
            SLIDERS.forEach(s => {
                const el = document.getElementById(s.id);
                if (!el) return;
                if (s.key && AppState.thresholds[s.key] !== undefined) el.value = AppState.thresholds[s.key];
                el.addEventListener('input', () => updateSliderBg(el, s));
                updateSliderBg(el, s);
            });
            refreshStats();
        })();
        /* ‚îÄ‚îÄ Theme ‚îÄ‚îÄ */
        let _theme = localStorage.getItem('fp_theme') || 'dark';
        function applyTheme(t) {
            _theme = t;
            document.getElementById('root').classList.toggle('light', t === 'light');
            document.getElementById('root').classList.toggle('dark', t !== 'light');
            document.getElementById('theme-icon').textContent = t === 'light' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('fp_theme', t);
        }
        function toggleTheme() { applyTheme(_theme === 'dark' ? 'light' : 'dark'); }
        applyTheme(_theme);
    </script>
</body>

</html>